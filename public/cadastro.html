<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="css/cadastro.css">
    <script src="js/cep.js"></script>
</head>

<body>
    <div class="login-banner">
        <div class="header">
            <div class="container">
                <h1 class="titulo">Korean Music</h1>
                <ul class="navbar">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="login.html">Login</a></li>
                    <li><a href="cadastro.html">Cadastro</a></li>
                </ul>
            </div>
        </div>
        <div class="container">
            <div class="alerta_erro">
                <div class="card_erro" id="cardErro">
                    <span id="mensagem_erro"></span>
                </div>
            </div>
            <!-- FORMULARIO CADASTRO -->
            <div class="form-cadastro" id="formCadastro">
                <div class="form-title">
                    <h2>Faça o seu cadastro</h2>
                </div>
                <div class="cadastro-campos">
                    <div class="campo-duplo">
                        <div class="campo">
                            <span class="nome_campo">Nome</span>
                            <input type="text" id="ipt_nome" placeholder="Nome" onkeypress="limpaBorda(this)">
                        </div>
                        <div class="campo">
                            <span class="nome_campo">Sobrenome</span>
                            <input type="text" id="ipt_sobrenome" placeholder="Sobrenome" onkeypress="limpaBorda(this)">
                        </div>
                    </div>
                    <div class="campo-duplo">
                        <div class="campo">
                            <span class="nome_campo">E-mail</span>
                            <input type="email" id="ipt_email" placeholder="E-mail" onkeypress="limpaBorda(this)">
                        </div>
                        <div class="campo">
                            <span class="nome_campo">Data de Nascimento</span>
                            <input type="text" id="ipt_datanasc" placeholder="DD/MM/AA" onkeypress="limpaBorda(this)">
                        </div>
                    </div>
                    <div class="campo-duplo">
                        <div class="campo">
                            <span class="nome_campo">Senha</span>
                            <input type="password" id="ipt_pass" placeholder="******" onkeypress="limpaBorda(this)">
                        </div>
                        <div class="campo">
                            <span class="nome_campo">Confirmar senha</span>
                            <input type="password" id="ipt_verpass" placeholder="******" onkeypress="limpaBorda(this)">
                        </div>
                    </div>
                    <div class="campo">
                        <span class="nome_campo">Grupo favorito:</span>
                        <select id="sel_grupo" onchange="limpaBorda(this)">
                            <option value="">Selecione uma opção</option>
                            <option value="1">BTS</option>
                            <option value="2">TWICE</option>
                            <option value="3">NCT</option>
                            <option value="4">BLACKPINK</option>
                            <option value="5">EXO</option>
                            <option value="6">ITZY</option>
                        </select>
                    </div>
                    <div class="btn_forgot">
                        <!-- <span class="forgot_pass"><a href="#">Esqueceu a senha?</a></span> -->
                        <button onclick="prox()">Próximo</button>
                    </div>
                    <span class="criar_acc">Já tem uma conta? <a href="#">Fazer login!</a></span>
                    <div id="div_erros"><span id="span_erro"></span></div>
                </div>
                <div class="endereco-campos">
                    <div class="campo-duplo"></div>
                </div>
            </div>
            <!-- FORMULARIO CADASTRO -->
            <!-- FORMULARIO ENDEREÇO -->
            <div class="form-endereco" id="formEndereco">
                <div class="form-title">
                    <h2>Preencha os dados do seu endereço</h2>
                </div>
                <div class="cadastro-campos">
                    <div class="campo-duplo">
                        <div class="campo">
                            <span class="nome_campo">CEP</span>
                            <input type="text" id="ipt_cep" placeholder="CEP" maxlength="9" onblur="buscaCEP()">
                        </div>
                        <div class="campo">
                            <span class="nome_campo">Rua</span>
                            <input type="text" id="ipt_rua" placeholder="Rua">
                        </div>
                    </div>
                    <div class="campo-duplo">
                        <div class="campo">
                            <span class="nome_campo">Bairro</span>
                            <input type="email" id="ipt_bairro" placeholder="Bairro">
                        </div>
                        <div class="campo">
                            <span class="nome_campo">Cidade</span>
                            <input type="text" id="ipt_cidade" placeholder="Cidade">
                        </div>
                    </div>
                    <div class="campo-duplo">
                        <div class="campo">
                            <span class="nome_campo">Estado</span>
                            <input type="text" id="ipt_estado" placeholder="Estado">
                        </div>
                        <div class="campo">
                            <span class="nome_campo">Número</span>
                            <input type="text" id="ipt_num" placeholder="Número">
                        </div>
                    </div>
                    <div class="btn_forgot">
                        <!-- <span class="forgot_pass"><a href="#">Esqueceu a senha?</a></span> -->
                        <button onclick="cadastrar()">Cadastrar</button>
                    </div>
                    <span class="criar_acc">Já tem uma conta? <a href="#">Fazer login!</a></span>
                    <div id="div_errosEnd"><span id="span_erroEnd"></span></div>
                </div>
            </div>
            <!-- FORMULARIO ENDEREÇO -->
        </div>
    </div>
</body>

</html>

<script>
    // TODO: CONFIGURAR MASCARA DE ENTRADA CAMPO INPUT DATA PARA DD-MM-YYYY
    // ALTERAR ELA PARA O PADRÃO DO BANCO DE DADOS MYSQL YYYY-MM-DD
    var nomeInput = document.getElementById("ipt_nome")
    var sobrenomeInput = document.getElementById("ipt_sobrenome")
    var emailInput = document.getElementById("ipt_email")
    var dtNascInput = document.getElementById("ipt_datanasc")
    var senhaInput = document.getElementById("ipt_pass")
    var confSenhaInput = document.getElementById("ipt_verpass")
    var favGroupInput = document.getElementById("sel_grupo")
    var cepInput = document.getElementById("ipt_cep")
    var ruaInput = document.getElementById("ipt_rua")
    var bairroInput = document.getElementById("ipt_bairro")
    var cidadeInput = document.getElementById("ipt_cidade")
    var estadoInput = document.getElementById("ipt_estado")
    var numInput = document.getElementById("ipt_num")
    
    var erro = false

    // função do botão para ir para a seção de preenchimento dos dados de endereço
    // verifica se os campos estão preenchidos, e avança somente se todos os campos forem válidos + senhas coincidirem
    function prox() {
        var inputs = [nomeInput, sobrenomeInput, emailInput, dtNascInput, senhaInput, confSenhaInput, favGroupInput]
    
        for (let i = 0; i < inputs.length; i++) {
            verifErro(inputs[i].value, inputs[i])
        }
        
        if (senhaInput.value != confSenhaInput.value) {
            senhaInput.style.border = 'solid 2px red'
            confSenhaInput.style.border = 'solid 2px red'
            erro = true
        }
        
        if (!erro) {
            formCadastro.style.display = 'none'
            formEndereco.style.display = 'flex'
        }
     erro = false
    }
    
    // função para limpar a borda das inputs
    function limpaBorda(input) {
        if (input == confSenhaInput || input == senhaInput) {
            senhaInput.style.border = 'none'
            confSenhaInput.style.border = 'none'
        } else {
            input.style.border = 'none'
        }
    }

    // função para verificar se a input tem erro e trocar a borda para vermelho
    function verifErro(valIpt, input) {
        if (valIpt == '') {
            erro = true
            input.style.border = 'solid 2px red'
        }
    }
    
    // função que verifica se os campos do endereço estão preenchidos
    function verif() {
        var inputs = [cepInput, ruaInput, bairroInput, cidadeInput, estadoInput, numInput]

        for (let i = 0; i < inputs.length; i++) {
            verifErro(inputs[i].value, inputs[i])
        }
        
        if (!erro) {
            cadastrar()
        }
        
        erro = false
    }

    function cadastrar() {
        var numVar = Number(numInput.value)
        // verifica se endereço existe, se já existe pega o ID do endereço para colocar como fk no cadastro do user
        // se não existe, cadastra um novo endereço com os dados
        fetch("/usuarios/endereco", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                cepServer: cepInput.value,
                ruaServer: ruaInput.value,
                bairroServer: bairroInput.value,
                cidadeServer: cidadeInput.value,
                estadoServer: estadoInput.value,
                numServer: numVar
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log(JSON.stringify(json))
                    alert('Já existe este endereço')
                })
            } else {
                console.log("Houve um erro ao tentar procurar/cadastrar o endereço")
            }
        }).catch(function (erro) {
            console.log(erro)
        })

        return false
        
        // fetch("/usuarios/cadastrar", {
        //     method: "POST",
        //     headers: {
        //         "Content-Type": "application/json"
        //     },
        //     body: JSON.stringify({
        //         nomeServer: nomeVar,
        //         sobrenomeServer: sobrenomeVar,
        //         emailServer: emailVar,
        //         dtNascServer: dtNascVar,
        //         senhaServer: senhaVar,
        //         favGroupServer: favGroupVar
        //     })
        // }).then(function (resposta) {
        //     console.log("resposta: ", resposta)

        //     if (resposta.ok) {
        //         alert("Cadastro realizado com sucesso!")
                
        //         setTimeout(() => {
        //             window.location = "login.html"
        //         }, "2000");
        //     } else {
        //         resposta.text().then(texto => {
        //             divErrosEnd.style.display = 'flex'
        //             spanErrosEnd.innerHTML = texto
        //         })
        //     }
        // }).catch(function (resposta) {
        //     console.log(`ERRO: ${resposta}`)
        // })

        // return false
    }
</script>